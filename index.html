<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>jerry&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="java, 分布式系统, thrift, storm, nosql" />
  
  
  
  
  <meta name="description" content="jerry&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="jerry&#39;s blog">
<meta property="og:url" content="https://jerrysearch.github.io/index.html">
<meta property="og:site_name" content="jerry&#39;s blog">
<meta property="og:description" content="jerry&apos;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jerry&#39;s blog">
<meta name="twitter:description" content="jerry&apos;s blog">
  
    <link rel="alternate" href="/atom.xml" title="jerry&#39;s blog" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<script>
var themeMenus = {};

  themeMenus["/"] = "首页"; 

  themeMenus["/archives"] = "归档"; 

  themeMenus["/about"] = "关于"; 

</script>


  <body>


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="jerry&#39;s blog" rel="home"> jerry&#39;s blog </a>
            
          </h1>

          
            <div class="site-description">jerry&#39;s blog</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">归档</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div style="background: #fff; width: 100%;">

      <div style="max-height:600px; overflow: hidden;  display: flex; display: -webkit-flex; align-items: center;">
        <img width="100%" alt="Hike News" src="/css/images/pose.jpg">
      </div>

  </div>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-cap-in-tns"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/04/10/cap-in-tns/">tns 中的CAP理论实践</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2017/04/10/cap-in-tns/" class="article-date">
	  <time datetime="2017-04-09T18:05:18.000Z" itemprop="datePublished">四月 10, 2017</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="cap"><a href="#cap" class="headerlink" title="cap"></a>cap</h1><p>C：一致性<br>A：可用性<br>P：分区容忍性</p>
<h1 id="Architecture-in-tns"><a href="#Architecture-in-tns" class="headerlink" title="Architecture in tns"></a>Architecture in tns</h1><p>集群采用无中心化设计，按节点ID排序并顺时针组成一个环，如图C1，节点按固定频率将其知道的cluster list、cluster node status和service list同步给下一个节点，并记录被同步节点的健康状态。</p>
<p><img src="https://cloud.githubusercontent.com/assets/2673307/24845340/e2a0de4a-1de3-11e7-93ed-e3fadc088e1c.png" alt="C1"></p>
<h2 id="故障检测"><a href="#故障检测" class="headerlink" title="故障检测"></a>故障检测</h2><p><strong>tns采用<code>增量故障检测算法</code>来检测集群故障。</strong></p>
<p><img src="https://cloud.githubusercontent.com/assets/2673307/24850685/9cc9d780-1e03-11e7-9b0f-183d8f42f0f0.png" alt="C2"></p>
<p>一个Up节点单次故障不会被立即标记为Down，而是被标记为Down_1，如果Down_1节点下次检测仍是故障，则会被标记为Down_2，如果Down_2节点下次检测仍是故障，则会被标记为Down，此后不会在对该节点执行故障检测。如下图:</p>
<p><img src="https://cloud.githubusercontent.com/assets/2673307/25260361/31c97fde-267e-11e7-9e7d-86b525cce418.png" alt="Cluster 状态机"></p>
<h2 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h2><h3 id="cluster视角"><a href="#cluster视角" class="headerlink" title="cluster视角"></a>cluster视角</h3><p>在tns中，不可变约束包括cluster node列表、cluster node健康状态、service node 列表。</p>
<p>tns 针对以上不可变约束满足<code>最终一致性</code></p>
<h4 id="增加node（cluster、service）"><a href="#增加node（cluster、service）" class="headerlink" title="增加node（cluster、service）"></a>增加node（cluster、service）</h4><p>假设数据同步周期为T，在某个cluster node上操作增加一个node（cluster、service），在最长同步周期（T）后数据会被同步到下个节点，以此类推，假设集群节点数为N，最终一致时间最长为（N－1）T</p>
<h4 id="移除node（service）"><a href="#移除node（service）" class="headerlink" title="移除node（service）"></a>移除node（service）</h4><p><code>tns目前只支持移除service node，对于cluster node的移除功能暂不支持。</code></p>
<p><img src="https://cloud.githubusercontent.com/assets/2673307/25260393/73cfa610-267e-11e7-8bd4-37f6df6bcbd0.png" alt="Service 状态机"></p>
<p>对于移除service node，cluster 需要经历四个阶段：Leaving、Tombstone_1、Tombstone、Remove</p>
<p>其中Tombstone_1、Tombstone、Remove阶段由后台任务周期执行触发</p>
<ul>
<li><p>Leaving阶段</p>
<ul>
<li>被移除的service node会被立即变更状态为Leaving，并取消对应的ping任务</li>
<li>在周期T内，状态会被传输到下个节点</li>
<li>最终在（N－1）T内，状态会被传输到所有节点</li>
</ul>
</li>
<li><p>Tombstone_1阶段</p>
<ul>
<li>检查service node状态<ul>
<li>若状态为Leaving，且已停留了足够长时间，将状态变更为Tombstone_1</li>
</ul>
</li>
</ul>
</li>
<li><p>Tombstone阶段</p>
<ul>
<li>检查service node状态<ul>
<li>若状态为Tombstone_1，且已停留了足够长时间，将状态变更为Tombstone</li>
</ul>
</li>
</ul>
</li>
<li><p>Remove阶段</p>
<ul>
<li>检查service node状态<ul>
<li>若状态为Tombstone，且已停留了足够长时间，直接移除</li>
</ul>
</li>
</ul>
</li>
<li><p>处于Leaving状态的节点仍会同步给其它节点；处于Tombstone_1、Tombstone状态的节点不会同步给其它节点；这三种状态均不接受状态更新；</p>
</li>
</ul>
<p><strong><em>为什么这么设计？</em></strong></p>
<blockquote>
<p>保证Leaving状态广播到整个集群；保证在真正移除前，集群所有节点处于Tombstone_1或Tombstone状态（保证移除后，该service node不会再被同步回来）。</p>
<p>假设处于Leaving状态的service node，未能广播给整个集群，会出现部分cluster node执行了移除操作，最终导致移除后被那些没能收到Leaving请求的节点将数据又同步回来，导致下线service node失败；另外，处于Tombstone状态的service node，节点一旦被执行移除，其上一个节点待移除数据可能处于Leaving甚至是UP状态，数据可能会被同步回来，最终导致集群出现错误，所以必须保证，在集群某节点在执行真正移除前，其余节点至少处于Tombstone_1或Tombstone状态。</p>
<p>详细推导过程见<a href="#一致性详解">一致性详解</a></p>
</blockquote>
<h3 id="client视角"><a href="#client视角" class="headerlink" title="client视角"></a>client视角</h3><p>目前版本客户端不考虑一致性问题，未来可能会增加<code>单调读一致性</code>，但需求不大</p>
<p>tns-client会定时从cluster同步数据，在这个周期内，可能会出现数据不一致。例如某时刻一个service node被移除或已经down 掉，并未及时被tns-client同步过来，可能会导致client使用一个错误的service node来执行业务，出现错误，在tns-client中提供了brokenNode接口来主动移除故障节点</p>
<h2 id="可用性"><a href="#可用性" class="headerlink" title="可用性"></a>可用性</h2><h3 id="cluster视角-1"><a href="#cluster视角-1" class="headerlink" title="cluster视角"></a>cluster视角</h3><p>tns中，集群节点数量N&gt;0即可写。</p>
<h3 id="client视角-1"><a href="#client视角-1" class="headerlink" title="client视角"></a>client视角</h3><p>tns中，集群节点数量N&gt;0即可读，同时因为tns是一个最终一致性的系统，节点的down机，会在（N－1）T内广播到整个集群，同时tns-client定时从某个cluster node同步数据也是定时操作，所以同步时某个节点可能不可用，此种情况可以采取两种措施：</p>
<ol>
<li>换个节点立即重试</li>
<li>等待下一个同步周期（选择到一个健康节点）</li>
</ol>
<p>目前tns-client采用方法2</p>
<h2 id="分区容忍性"><a href="#分区容忍性" class="headerlink" title="分区容忍性"></a>分区容忍性</h2><p>一般认为在同一个机房不会出现分区，在跨机房场景中会出现分区现象；同时在同机房内节点的上下线也被认为是特殊的分区。如图C3:<br><img src="https://cloud.githubusercontent.com/assets/2673307/24850816/1584a1dc-1e04-11e7-9935-af87a464c4c3.png" alt="C3"></p>
<p>tns不满足跨机房的分区容忍性，如果跨机房部署，出现分区情况，在没有人为增加、移除节点的情况下没有问题（tns中节点的增加、移除操作均为人工操作），所以这样部署问题也不大，只要在操作前检查下集群状态即可，操作后检查下结果是否已经被广播到整个集群。</p>
<h2 id="一致性详解"><a href="#一致性详解" class="headerlink" title="一致性详解"></a>一致性详解</h2><p><strong>cluster中有三个关键时间或周期</strong></p>
<ol>
<li>cluster间同步数据的周期 T1</li>
<li>service节点Leaving、Tombstone_1、Tombstone状态保留最短时间 T2</li>
<li>后台执行service node移除的周期 T3</li>
</ol>
<h3 id="cluster-之移除service-node"><a href="#cluster-之移除service-node" class="headerlink" title="cluster 之移除service node"></a>cluster 之移除service node</h3><p>前文已经介绍，下线一个service node需要处理好如下两件事情：</p>
<blockquote>
<p>保证Leaving状态广播到整个集群；<br>保证在真正移除前，集群所有节点处于Tombstone_1或Tombstone状态（<em>保证移除后，该service node不会再被同步回来</em>）</p>
</blockquote>
<h4 id="接下来看看三个周期需要满足什么条件？"><a href="#接下来看看三个周期需要满足什么条件？" class="headerlink" title="接下来看看三个周期需要满足什么条件？"></a>接下来看看三个周期需要满足什么条件？</h4><p>若要保证Leaving状态广播到整个集群，只需保证每个节点都能将Leaving状态同步给下个节点，即在Leaving状态被转换成Tombstone_1前，至少发生过一次同步操作，推导出 <strong>T2 &gt; T1</strong></p>
<p>若要保证真正移除前，集群所有节点处于Tombstone_1、或Tombstone状态，只需保证，集群最早执行移除操作的时间 <strong>(TR)</strong> &gt; 集群最晚将节点状态转成Tombstone_1的时间 <strong>(TT)</strong>。</p>
<p>根据集群最终一致性性质，不难推算出，集群最晚收到Leaving的时间为 <strong>(N － 1）T1</strong>，从Leaving到Tombstone_1最长时间为 <strong>T2 + T3</strong>，所以 <strong>TT ＝ (N - 1)T1 + T2 + T3</strong></p>
<p>同理，<strong>TR = T2 + 2T3</strong></p>
<p>进而可推算出：</p>
<p>TR &gt; TT </p>
<p>=&gt; T2 + 2T3 &gt; (N - 1)T1 + T2 + T3 </p>
<p>=&gt; T3 &gt; (N - 1)T1</p>
<p>综上，cluster三个周期需满足：</p>
<ul>
<li><strong>T2 &gt; T1</strong></li>
<li><strong>T3 &gt; (N - 1)T1</strong></li>
</ul>
<h4 id="回过头来，假设没有Tombstone-1阶段是否可行？"><a href="#回过头来，假设没有Tombstone-1阶段是否可行？" class="headerlink" title="回过头来，假设没有Tombstone_1阶段是否可行？"></a>回过头来，假设没有Tombstone_1阶段是否可行？</h4><p>根据上文推算过程，可得出 </p>
<p>TT ＝ (N - 1)T1 + T2 + T3</p>
<p>TR = T2 + T3</p>
<p>显然，无法满足 TR &gt; TT，所以 <strong>Tombstone_1阶段是必要的</strong></p>
<h4 id="集群节点数上限"><a href="#集群节点数上限" class="headerlink" title="集群节点数上限"></a>集群节点数上限</h4><p>根据上边的推算，T3 &gt; (N - 1)T1，目前T3 ＝ 10分钟，T1 ＝ 5秒，可得 N不能超过121，对于tns负载特点，120完全足够，一般三个节点即能满足大多数系统需求</p>
<h3 id="最终一致时间"><a href="#最终一致时间" class="headerlink" title="最终一致时间"></a>最终一致时间</h3><p>接下来看下集群最终一致时间到底要多长</p>
<h4 id="提前须知"><a href="#提前须知" class="headerlink" title="提前须知"></a>提前须知</h4><ul>
<li>对于增加节点（cluster、service），初始状态均为Joining，只有UP状态的节点才会同步给客户端</li>
<li>对于增加cluster node，待增加的node状态只能被其上一个节点修改</li>
</ul>
<h4 id="增加cluster-node"><a href="#增加cluster-node" class="headerlink" title="增加cluster node"></a>增加cluster node</h4><p>根据cluster 特性可知，一旦待添加的节点，被其上一个节点修改状态为UP，然后最终使集群达到最终一致（UP），需要时间 <strong>(N - 1)T1</strong></p>
<p>那么待添加节点状态变为UP状态需要多长时间呢？</p>
<p>假如，操作的节点正好是待添加节点的上一个节点，那么由Joining - &gt; UP ,至多需要T1时间，从而最终UP一致时间最长为：<strong>T1 + (N - 1)T1 = NT1</strong></p>
<p>假如，操作的节点正好是待添加节点的下一个节点，那么由Joining - &gt; UP ，至多需要NT1时间，从而最终UP一致时间最长为：<strong>NT1 ＋ (N - 1)T1 = (2N - 1)T1</strong></p>
<h4 id="增加service-node"><a href="#增加service-node" class="headerlink" title="增加service node"></a>增加service node</h4><p>根据cluster特性可知，Joining状态的service node同步到整个集群需要(N - 1)T1时间，然后Joining - &gt; UP 由各自的cluster node负责ping检测，其中检测启动时间为Random( pingFrequency )，从而最终UP一致时间最长为：<strong>(N - 1)T1 + pingFrequency</strong></p>
<h4 id="下线service-node"><a href="#下线service-node" class="headerlink" title="下线service node"></a>下线service node</h4><p>根据cluster特性可知，Leaving状态的service node同步到整个集群需要(N - 1)T1时间，一旦集群达到Leaving一致状态，客户端即获取不到该service node，所以对于客户端而言，最终一致时间最长为：<strong>(N - 1)T1</strong></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/tns/">tns</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gray-release/">gray release</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/high-availability/">high availability</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/horizontal-scaling/">horizontal scaling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/load-balancing/">load balancing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thrift/">thrift</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-tns-different-usage-and-gray-release"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2016/04/18/tns-different-usage-and-gray-release/">tns两种使用模式和灰度发布</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2016/04/18/tns-different-usage-and-gray-release/" class="article-date">
	  <time datetime="2016-04-17T18:05:18.000Z" itemprop="datePublished">四月 18, 2016</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>tns客户端tnsclient支持不同的使用模式，包括load balance、master\slave模式，接下来介绍不同模式的作用和设计原理</p>
<h2 id="load-balance"><a href="#load-balance" class="headerlink" title="load balance"></a>load balance</h2><p>在集群模式中，一个请求过来后要通过某种策略将请求分配到后台某个服务器上，这个策略我们可以称为负载均衡</p>
<p>tns采用加权随机的方法实现负载均衡</p>
<p>举例：服务serviceA下面有3个实例，对不同的实例分配不同的vNodes个数（权重），假如：a1:2；a2:4；a3:4，那么客户端会将请求的2/10分配到a1节点，将请求的4/10分配到a2节点或a3节点，从而实现了负载均衡</p>
<p>在tnsclient中使用<code>LoadbalanceTSNodeIndexBuilder</code>和<code>RandomTSNodeSelector</code></p>
<h2 id="master-slave"><a href="#master-slave" class="headerlink" title="master\slave"></a>master\slave</h2><p>在集群模式中，我们希望将请求分发到主节点（master），然后当master down后，将请求分发到某slave节点</p>
<p>大多数分布式系统master/slave由分布式系统本身实现，即系统自身包含一个监控组件，当监控组件检测到master不可用后自动提升某slave为master，典型代表为zookeeper（leader、flower）</p>
<p>tns自身并不提供master\slave功能，通过tnsclient在调用某个服务时实现。同样基于vNodes机制,tnsclient将获取到的某服务的所有实例,根据vNodes进行自然排序，vNodes小的节点优先，若vNodes相同，再根据id进行排序</p>
<p>同上面例子，如果采用master\slave模式，a1 vnodes最小，排在第一位，作为master；假如a1 down掉，那么a2或a3被提升为master，此时a2和a3 vnodes相同，所以id小的会被提升为master</p>
<p>在tnsclient中使用<code>MaterSlaveTSNodeIndexBuilder</code>和<code>MasterSlaveTSNodeSelector</code></p>
<h2 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h2><p>所谓灰度发布，就是对要发布的程序先小批量上线，一旦出现问题，不至于影响到所有用户。</p>
<p>tns实现方式天然具有灰度发布的特性。基于vNodes，并且采用load balance模式，我们只需将发布的新节点的vNodes设置比较小（权重低），那么线上的流量只会有一小部分流到这个新节点，从而实现灰度发布的效果</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/tns/">tns</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gray-release/">gray release</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/high-availability/">high availability</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/horizontal-scaling/">horizontal scaling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/load-balancing/">load balancing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thrift/">thrift</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-tns-cluster-introduction"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2016/01/11/tns-cluster-introduction/">tns cluster简介</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2016/01/11/tns-cluster-introduction/" class="article-date">
	  <time datetime="2016-01-10T18:05:18.000Z" itemprop="datePublished">一月 11, 2016</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/jerrysearch/tns" target="_blank" rel="external">tns</a>（thrift name server）是我在<a href="http://700store.com/" target="_blank" rel="external">700Bike</a>开发的一个thrift rpc分布式组件，可以实现高可靠、负载均衡、动态水平扩展等.</p>
<p>   相比haproxy、zookeeper等有什么优势？我们知道网络程序唯一保证可靠的方式就是心跳包，同haproxy方式有什么区别，可以阅读wiki <a href="https://github.com/jerrysearch/tns/wiki" target="_blank" rel="external">why</a></p>
<p>   使用方式wiki上都有，这里简单说说tns cluster的特性，及设计结构。</p>
<h2 id="cluster结构图"><a href="#cluster结构图" class="headerlink" title="cluster结构图"></a>cluster结构图</h2><p><img src="https://static.oschina.net/uploads/img/201602/23130943_dhhT.jpg" alt="cluster结构图" title="cluster"></p>
<p>   tns cluster 采用无中心化设计，也就是cluster中每个node都是均等的，在任一节点执行命令都等效，集群组件类似于redis，在节点上执行meet <other host="">即可，满足传递性，例如： 1 meet 2；2 meet 3 等效于1 meet 3； 1 meet 2</other></p>
<p>   每个node均有一个ID，ID唯一，根据hostname＋port生成，在集群中cluster按ID排序，组成一个环，如上图绿色环,其中ID较小的会负责检查比其稍大的ID的节点健康状态，并将自己知道的cluster list及健康状态和service list（不包含健康状态）传输到对方，实现集群信息同步，假如2节点Down了，1会标记2节点状态为down，并将自己的信息以后同步给3，因为2一旦down掉，是不可自动恢复的，只能手动恢复（重启2，并执行meet 重新上线）.<br>    如上，这种做法，一个节点有且仅有一个节点会同步信息给它，并且它也只同步信息给一个节点，集群增加节点不会增加单个node的压力。service list只会同步列表，不会同步service节点状态，避免1节点状态传递到6延迟比较高，每个tns节点自行维护service 状态，这样客户端不论从那个cluster node中同步service列表均比较实时。</p>
<h2 id="tns内部结构图"><a href="#tns内部结构图" class="headerlink" title="tns内部结构图"></a>tns内部结构图</h2><p><img src="https://static.oschina.net/uploads/img/201602/23131200_0TGz.jpg" alt="tns" title="内部结构图"></p>
<p>   如图，在nameserver中添加三个rpc server节点，service名称定义为drpc，每增加一个节点时，可以指定ping的周期，nameserver会定时调用drpc的ping方法，ping方法返回vNodes，含义为虚拟节点，用于客户端对请求负载均衡，另外nameserver也根据每次ping返回的vNodes值来判断service server是否可用，若vNodes&lt;0，nameserver会标记service node为down，nameserver只会同步UP状态的service节点列表给客户端，增加或下线一个节点，一个周期后（客户端设定周期）也会被客户端同步到。</p>
<p>   单个的vNodes没什么含义，在一个service下有多个node时才有含义，例如上图中drpc包含三个节点，并且每个节点vNodes分别为7、2、1，客户端负载均衡后，其中7/10的流量会流向node1，1/10会流向node3，从而实现负载均衡，客户端默认提供一个随机选择器，大家可以按自己的意愿自己实现。</p>
<p>   线上不论是tns node还是service node均可随时增加或减少，从而实现水平动态可扩展。</p>
<p>   详细使用帮助文档，朋友们可以参考thriftnameserver 的WIKI。</p>
<hr>
<p><img src="https://static.oschina.net/uploads/img/201601/12170350_IOZ2.png" alt="tns交流群" title="tns交流群"></p>
<p><strong>jerry 于北京<br>2016-1-11</strong></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/tns/">tns</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gray-release/">gray release</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/high-availability/">high availability</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/horizontal-scaling/">horizontal scaling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/load-balancing/">load balancing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thrift/">thrift</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-rocketmq_completion"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2015/12/20/rocketmq_completion/">rocketmq 命令行自动补全工具</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2015/12/20/rocketmq_completion/" class="article-date">
	  <time datetime="2015-12-19T18:05:18.000Z" itemprop="datePublished">十二月 20, 2015</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/jerrysearch/rocketmq_completion" target="_blank" rel="external">rocketmq_completion</a>是为<a href="https://github.com/alibaba/RocketMQ" target="_blank" rel="external">rocketmq</a>开发的命令行自动补全工具，主要方便用户使用rocketmq时，减少命令行交互的成本及出错的概率!</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>rocketmq_completion只有一个脚本，借助Linux中complete及compgen技术实现</p>
<ul>
<li>从github上download到本地或服务器任何目录下，例如：<code>/your_path/rocketmq_completion/rocketmq_completion</code></li>
<li>在本机bash_completion.d目录下，建立对应软连接(需要root权限)，注：不同Linux发行版目录地址不同，用户可根据自己系统版本 google</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /etc/bash_completion.d/</div><div class="line">ln -s /your_path/rocketmq_completion/rocketmq_completion</div></pre></td></tr></table></figure>
<ul>
<li>在bash_profile下填加一行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source /etc/bash_completion.d/rocketmq_completion</div></pre></td></tr></table></figure>
<ul>
<li>重新打开一个新窗口，检查completion是否起作用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">complete －p</div></pre></td></tr></table></figure>
<ul>
<li>输出中出现以下内容表示成功</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">complete -F _mqadmin mqadmin</div></pre></td></tr></table></figure>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./mqadmin[tab]</div><div class="line">./mqadmin clusterList [-tab][--tab]</div></pre></td></tr></table></figure>
<p>参数部分 -表示必选参数，–表示可选参数</p>
<h2 id="关于升级"><a href="#关于升级" class="headerlink" title="关于升级"></a>关于升级</h2><ul>
<li>目前版本只实现了mqadmin脚本的自动补全</li>
<li>未来对其它脚本的补全会持续更新，实现方式是在rocketmq_completion脚本下添加_command方法并complete -F  _command command方式来实现，以上用法中的步骤用户无需重复操作，即可实现对新增命令的支持</li>
</ul>
<h2 id="关于作者"><a href="#关于作者" class="headerlink" title="关于作者"></a>关于作者</h2><p>坚持走技术路线的码农一枚</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/rocketmq/">rocketmq</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rocketmq/">rocketmq</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tool/">tool</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-zkconfigutil_8"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2015/04/17/zkconfigutil_8/">彻底摆脱配置文件 八(使用maven-zkcu-plugin灵活控制zkconfigutil)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2015/04/17/zkconfigutil_8/" class="article-date">
	  <time datetime="2015-04-16T18:05:18.000Z" itemprop="datePublished">四月 17, 2015</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>惯例，我们从使用上开始。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>首先，下载并构建<a href="https://github.com/jerrysearch/zkcu-plugin" target="_blank" rel="external">maven-zkcu-plugin</a></p>
<p>这是一个maven工程，采用maven构建并install本地即可</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>接下来我们主要看效果：<br>我有一个配置类，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@TypeZkConfigurable</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticClass</span> </span>&#123;</div><div class="line"><span class="meta">@FieldZkConfigurable</span>(dynamicUpdate = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> String a = <span class="string">"hello world a"</span>;</div><div class="line"><span class="meta">@FieldZkConfigurable</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> String b = <span class="string">"hello world b"</span>;</div><div class="line"></div><div class="line"><span class="meta">@TypeZkConfigurable</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InClass</span></span>&#123;</div><div class="line">        <span class="meta">@FieldZkConfigurable</span>(dynamicUpdate = <span class="keyword">true</span>)</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> String c = <span class="string">"hello world c"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 接下来看下关键的，如何使用maven-zkcu-plugin，实现彻底摆脱配置文件，并又能灵活控制配置功能开关。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;plugin&gt;</div><div class="line">    &lt;groupId&gt;com.jerry&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;maven-zkcu-plugin&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;0.1.1&lt;/version&gt;</div><div class="line"></div><div class="line">    &lt;configuration&gt;</div><div class="line">	&lt;zk&gt;127.0.0.1:2181&lt;/zk&gt;</div><div class="line">	&lt;mainClass&gt;com.jerry.testplugin.TestStatic&lt;/mainClass&gt;</div><div class="line">	&lt;zkConfigurableClass&gt;</div><div class="line">	    &lt;parm&gt;com.jerry.testplugin.StaticClass&lt;/parm&gt;</div><div class="line">	    &lt;parm&gt;com.jerry.testplugin.StaticClass$InClass&lt;/parm&gt;</div><div class="line">	&lt;/zkConfigurableClass&gt;</div><div class="line">    &lt;/configuration&gt;</div><div class="line">&lt;/plugin&gt;</div></pre></td></tr></table></figure>
<p>这里有几个参数，其中zk代表配置项保存在哪个zookeeper上；mainClass代表你的程序启动的主函数；zkConfigurableClass代表所有工程里需要配置的类，也就是添加了<code>@TypeZkConfigurable</code>注解的类</p>
<p>看看如何使用，在你工程pom文件所在目录下，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean compile zkcu:zkcu jar:jar</div></pre></td></tr></table></figure>
<p>即可，强调下，zkcu必须在compile阶段之后执行，ok，现在你的服务已经有了zkconfigutil的功能。</p>
<p>有些时候，可能想关掉zkconfigutil，那么执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean package</div></pre></td></tr></table></figure>
<p>也就是去掉zkcu:zkcu即可。</p>
<p>特别强调下，zkcu这个plugin只能用户手动执行，无法被绑到某个maven生命周期上，这样做的目的是可能由用户控制zkconfigutil的开关。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>zkconfigutil采用注解的方式，实现了一个服务的配置项zookeeper化，增加dynamicUpdate = true，即可实现服务内部参数的动态更新，采用maven plugin方式，可以灵活在构建工程时控制是否使用zkconfigutil功能。 另外，如果不想将一些参数直接写在zkcu-plugin下面，也可以采用-D参数形式，为该plugin提供参数。</p>
<hr>
<p>jerry于2015-04-17</p>
<p>北京</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/zkconfigutil/">zkconfigutil</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-zkconfigutil_7"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2014/08/13/zkconfigutil_7/">彻底摆脱配置文件 七(基于linux USER2信号检查当前管理的配置项信息)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2014/08/13/zkconfigutil_7/" class="article-date">
	  <time datetime="2014-08-12T18:05:18.000Z" itemprop="datePublished">八月 13, 2014</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p> 基于linux USER2信号检查zkconfigutil当前管理的配置信息</p>
<p>当zkconfigutil管理的配置项过多时，我们也不确定是否有漏配置的，这个功能可以理解为配置项检查。</p>
<p>基于linux signal实现，使用起来比较方便，向kill -9或kill -15一样，使用这个功能只需执行kill -12 或kill -s USER2 即可，相关信息会以info级别打印到log中。</p>
<p>看下效果：<br><img src="http://static.oschina.net/uploads/space/2014/0813/033046_wi56_1376388.png" alt=""></p>
<p>ubuntu下没有找到图片处理程序，兄弟们扫一眼也能看出来，看SonHelper这四行，可以看到目前监控了四个配置项，所在的类名均为com.jerry.zkconfigutil.Demo   配置想项分别为字段F1、F2、F3、F4，用到的resolve均为Reflectesolve，并且F1～F3需要动态更新，F4不需要动态更新</p>
<hr>
<p>jerry 于 2014-08-13 03：36</p>
<p>广州出差宾馆</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/zkconfigutil/">zkconfigutil</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-zkconfigutil_6"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2014/07/07/zkconfigutil_6/">彻底摆脱配置文件 六(使用zkconfigutil和eclipse zookeeper插件配置脚本)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2014/07/07/zkconfigutil_6/" class="article-date">
	  <time datetime="2014-07-06T18:05:18.000Z" itemprop="datePublished">七月 7, 2014</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>对一个脚本的配置和普通配置项没什么两样。直接上个图再解释！</p>
<p>隆重为大家介绍我一直使用的eclipse zookeeper插件，博客地址：<a href="http://www.taobaotest.com/blogs/qa?bid=15305，请分享者的著作权！！！" target="_blank" rel="external">http://www.taobaotest.com/blogs/qa?bid=15305，请分享者的著作权！！！</a></p>
<p>首先我们有个配置项名字为“F1”，在没修改前内容为：<br><img src="http://static.oschina.net/uploads/space/2014/0707/161102_q4GD_1376388.png" alt=""></p>
<p>从这个截图上能清楚看到eclipse的zookeeper插件我们选择的是Text窗口，也就是字符串，内容为F321，接下来我们就直接利用这个eclipse zookeeper插件修改F1字段的值，将其修改为一个文件的内容，还是直接上图：<br><img src="http://static.oschina.net/uploads/space/2014/0707/161312_P8RC_1376388.png" alt=""></p>
<p>从这张截图大家看到，我这里利用eclipse zookeeper插件选择File窗口（这里可以直接import文件，或export文件），直接import一个awk脚本，ok，ctrl+s保存，看到F1字段的值直接变成了文件的内容。</p>
<p>通过以上简单介绍，不知大家有没有感觉，假如我们有一个分布式服务，每台机器上都需要有一个配置文件，修改起来要修改N遍，通过这种方式，我们即摆脱了配置文件，也实现了一处修改影响所有的效果。</p>
<p>注意：zookeeper不是数据库，不应该进行过频繁的更新操作，然后zookeeper本身有对node大小的限制，默认是1M？ 如果你的文件太大了，需要修改这项配置，不然会报错!</p>
<hr>
<p>JERRY 于2014.7.7 16:21</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/zkconfigutil/">zkconfigutil</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-zkconfigutil_5"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2014/07/05/zkconfigutil_5/">彻底摆脱配置文件 五(基于javaagent实现zkconfigutil对程序零侵入)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2014/07/05/zkconfigutil_5/" class="article-date">
	  <time datetime="2014-07-04T18:05:18.000Z" itemprop="datePublished">七月 5, 2014</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前使用zkconfigutil大致是两步，对要配置的pojo添加注解，然后需要zkconfigutil.register(class)。这样对程序造成了一定的侵入。今天为大家带来这个1.0.1版本，也是第一个正式的版本，这个版本添加对-javaagent的支持，来完全解决侵入问题，大神别急，待小弟慢慢道来！！！</p>
<p>先来效果：</p>
<p>我的工程中有个Demo是整个工程的配置项，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@TypeZkConfigurable</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@FieldZkConfigurable</span>(dynamicUpdate = <span class="keyword">true</span>)</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String F1 = <span class="string">"F1"</span>;</div><div class="line"></div><div class="line">	<span class="meta">@FieldZkConfigurable</span>(dynamicUpdate = <span class="keyword">true</span>)</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String F2 = <span class="string">"F2"</span>;</div><div class="line"></div><div class="line">	<span class="meta">@FieldZkConfigurable</span>(dynamicUpdate = <span class="keyword">true</span>)</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Boolean F3 = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="meta">@FieldZkConfigurable</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Boolean F4 = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个配置项F1字段dynamicUpdate = true，代表这个字段需要动态更新，即zookeeper上的值变化后F1需要做出相应修改。F4字段采用采用默认dynamicUpdate false，也就是不需要动态更新。</p>
<p>如何使用Demo：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">			System.out.println(<span class="string">"Demo.F1 = "</span> + Demo.F1);</div><div class="line">			loop();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread.sleep(<span class="number">2000L</span>);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>这段代码不需多解释，2s打印一次F1（这个字段可是动态更新的哦！）</p>
<p>ok代码已经写完了，是不是对您的代码完全没有侵入呢？</p>
<p>看启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-javaagent:/home/jerry/ZKCUAgent.jar=zk@10.31.44.38:2181<span class="comment">#class@com.jerry.zkconfigutil.Demo</span></div></pre></td></tr></table></figure>
<p>这里主要用了javaagent，在jvm参数中添加上述参数，首先-javaagent指定我们的agent的jar，这里在我的home目录下，然后=号用来指定agent的agentOps，也就是参数，格式为zk@z1,z2#class@c1,c2,c3。</p>
<p>ok，带上javaagent参数后直接启动，现在我们的Demo已经实现了zookeeper化配置。</p>
<p>欣赏下吧！<br>启动程序运行如下：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0705/141056_AZ1l_1376388.png" alt=""></p>
<p>修改zookeeper上F1字段的值为F321，运行如下：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0705/141536_XPZX_1376388.png" alt=""></p>
<p>怎么样，使用起立是不是非常easy，并且实用，通过jvm的javaagent参数进行控制，对服务实现零侵入。与zookeeper的eclipse插件是个完美的组合！！！</p>
<p>这是小弟发布的第一个正式版本，在osc的git仓库和github上都有完整代码及测试Demo，如果你有更好的想法真切希望你加入！！！</p>
<hr>
<p>JERRY 于2014.07.05  14:22</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/zkconfigutil/">zkconfigutil</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-zkconfigutil_4"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2014/04/02/zkconfigutil_4/">彻底摆脱配置文件 四(基于反射的通用resolve详解)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2014/04/02/zkconfigutil_4/" class="article-date">
	  <time datetime="2014-04-01T18:05:18.000Z" itemprop="datePublished">四月 2, 2014</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前虽然提供了生成通用resolve的template，改善了代码开发的代价，但生成的resolve过多，导致代码长度过度增长，使用ReflectResolve便可解决这个问题。</p>
<p>目前resolve从使用方式上有两种情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FieldZkConfigurable</span>(resolve = DemoResolve.DemoF1Resolve.class, dynamicUpdate = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> String F1 = <span class="string">"F1"</span></div><div class="line"><span class="meta">@FieldZkConfigurable</span>(dynamicUpdate = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> String F2 = <span class="string">"F2"</span>;</div><div class="line"></div><div class="line"><span class="meta">@FieldZkConfigurable</span>(dynamicUpdate = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Boolean F3 = <span class="keyword">false</span>;</div></pre></td></tr></table></figure>
<p>第一种，明确指定resolve，采用这种方式会比较灵活，一对一对应字段F1，逻辑可以自己方便控制，甚至可以加上一些逻辑而不是简单的赋值。</p>
<p>第二种，没有指定resolve，采用默认的ReflectResolve，这种方式减少代码的编写，及缓解代码的膨胀，这个resolve，采用反射机制，所以其有一定的局限性，但基本可以满足90%的需求，目前支持字段类型为：String、Long、Integer、Float、Double、Short、Boolean、及自定义类型VisualType（VisualType的子类），从本人测试的效果看，同样非常稳定。</p>
<p>第二种方式在使用上大大简化了开发者的开发工作，如果您的配置不需要自动动态更新，dynamicUpdate=true都可以去掉，最后只剩下一个简单的注解，即可实现属性的zookeeper配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FieldZkConfigurable</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Boolean F4 = <span class="keyword">true</span>;</div></pre></td></tr></table></figure>
<p>为了满足大多数用户的需求，除了java中可以使用valueOf方法反序列化的类型之外，还提供了VisualType类型，从名字上看大家应该明白了，就是“可视化类型”，只要您的属性类型继承自VisualType，并重写valueOf和toString方法也可通过ReflectResolve实现zookeeper配置当然也可动态更新。</p>
<p>最新代码可以从项目主页获取，欢迎大家试用，并提供宝贵意见，当然也非常愿意您的加入！！！</p>
<hr>
<p>jerry 于 2014-04-02 13:08</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/zkconfigutil/">zkconfigutil</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-zkconfigutil_3"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2014/03/17/zkconfigutil_3/">彻底摆脱配置文件 三(zkconfigutil通用resolve自动生成)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2014/03/17/zkconfigutil_3/" class="article-date">
	  <time datetime="2014-03-16T18:05:18.000Z" itemprop="datePublished">三月 17, 2014</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>系列文章见本人博客 </p>
<p>cast_resolve_template.xml文件在工程template下,地址：cast_resolve_template</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoF3Resolve</span> <span class="keyword">extends</span> <span class="title">AbstractResolve</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">resolve</span><span class="params">()</span> </span>&#123;</div><div class="line">    	<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">    	<span class="keyword">return</span> Demo.F3.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dResolve</span><span class="params">(String src)</span> </span>&#123;</div><div class="line">    	<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">    	Demo.F3 = Demo.F3.getClass().cast(src);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有了这个模板，只要需要配置的属性可以string表示，就可用该模板生成通用resolve，生成后无需再修改</p>
<hr>
<p>jerry 于 2014-03-17</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/zkconfigutil/">zkconfigutil</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div class="widget-wrap" style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 75%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 42px;" placeholder=" 搜索…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="搜索">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">联系我们</h3>
    <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
          
     			  <li><a href="https://github.com/jerrysearch" title="Github"><i class="fa fa-github" aria-hidden="true"></i></a></li> 
          
   		
          
            <li><a href="mailto:search.jerry@gmail.com?subject=请联系我&body=我能帮你什么" title="email"><i class="fa fa-envelope" aria-hidden="true"></i></a></li> 
          
   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a></li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>
		</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>最新文章</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2017/04/10/cap-in-tns/">tns 中的CAP理论实践</a></h6>
              <span>四月 10, 2017</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2016/04/18/tns-different-usage-and-gray-release/">tns两种使用模式和灰度发布</a></h6>
              <span>四月 18, 2016</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2016/01/11/tns-cluster-introduction/">tns cluster简介</a></h6>
              <span>一月 11, 2016</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2015/12/20/rocketmq_completion/">rocketmq 命令行自动补全工具</a></h6>
              <span>十二月 20, 2015</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2015/04/17/zkconfigutil_8/">彻底摆脱配置文件 八(使用maven-zkcu-plugin灵活控制zkconfigutil)</a></h6>
              <span>四月 17, 2015</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2014/08/13/zkconfigutil_7/">彻底摆脱配置文件 七(基于linux USER2信号检查当前管理的配置项信息)</a></h6>
              <span>八月 13, 2014</span>
            </div>

          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/rocketmq/">rocketmq</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tns/">tns</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/zkconfigutil/">zkconfigutil</a><span class="category-list-count">8</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/distributed-system/">distributed system</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gray-release/">gray release</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/high-availability/">high availability</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/horizontal-scaling/">horizontal scaling</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/load-balancing/">load balancing</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rocketmq/">rocketmq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thrift/">thrift</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/">tool</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/">zookeeper</a><span class="tag-list-count">8</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>

    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">二月 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2017 jerry&#39;s blog All Rights Reserved.
          
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
